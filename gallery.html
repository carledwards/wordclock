<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Word Clock â€” Theme Gallery</title>
    <style>
      :root { color-scheme: light dark; --tile-aspect: 16 / 9; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.4;
        padding: 16px;
        background: #0b0b0b;
        color: #eaeaea;
      }
      h1 { font-size: 1.25rem; margin: 0; font-weight: 600; }
      .header {
        position: sticky; top: 0; z-index: 30; background: #0b0b0b;
        padding: 8px 0 0; border-bottom: 1px solid #141414;
      }
      .header-top { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
      .subtle { color: #aaa; font-size: 0.9rem; margin-bottom: 16px; }
      .controls {
        padding: 8px 0 12px; border-bottom: 1px solid #141414; margin-bottom: 12px;
        display: flex; align-items: center; gap: 12px; justify-content: flex-start;
      }
      .segmented {
        display: inline-flex; align-items: stretch; overflow: hidden;
        border: 1px solid #262626; border-radius: 999px;
        background: rgba(255,255,255,0.05);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      }
      .segmented .seg {
        appearance: none; border: 0; margin: 0; background: transparent; color: #e0e0e0;
        padding: 8px 12px; font-size: 0.9rem; cursor: pointer;
      }
      .segmented .seg + .seg { border-left: 1px solid #262626; }
      .segmented .seg.active { background: rgba(255,255,255,0.12); color: #fff; }
      .title {
        align-self: center;
        color: #e6e6e6;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 999px;
        padding: 6px 10px;
        margin: 8px 0 0;
        opacity: 0.95;
      }
      .section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: min(100%, 1100px);
        margin: 48px auto 0;
        padding: 16px 16px 20px;
        border-radius: 14px;
        border: 1px solid #262626;
        background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        box-shadow:
          0 10px 28px rgba(0,0,0,0.40),
          inset 0 1px 0 rgba(255,255,255,0.06);
        transition: box-shadow 160ms ease, transform 160ms ease;
      }
      .section:hover {
        box-shadow:
          0 14px 36px rgba(0,0,0,0.45),
          inset 0 1px 0 rgba(255,255,255,0.07);
        transform: translateY(-1px);
      }
      .section + .section {
        margin-top: 64px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 32px;
        justify-items: center;
      }
      .card {
        position: relative; border-radius: 8px; overflow: hidden; background: #161616; border: 1px solid #232323;
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        aspect-ratio: var(--tile-aspect);
      }
      .card iframe {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
        background: #000;
      }
      .badge {
        position: absolute; left: 8px; bottom: 8px;
        background: rgba(0,0,0,0.66); color: #fff; padding: 4px 8px; border-radius: 999px;
        font-size: 12px; letter-spacing: .3px; border: 1px solid rgba(255,255,255,0.15);
        backdrop-filter: blur(2px);
        pointer-events: none;
      }
      .link {
        color: #9cdcff; text-decoration: none; font-size: 0.9rem;
      }
      .link:hover { text-decoration: underline; }
      .noscript {
        background: #221; border: 1px solid #533; padding: 12px; border-radius: 8px; margin-top: 12px;
      }
      .card--lg { background: transparent; border: 0; box-shadow: none; }
    </style>
    <script src="themes/theme.js"></script>
  </head>
  <body>
    <div class="header">
      <div class="header-top">
        <h1>Word Clock Theme Gallery</h1>
      </div>
      <div class="controls">
        <div class="segmented" role="radiogroup" aria-label="Event selector">
          <button type="button" class="seg active" data-mode="now" role="radio" aria-checked="true">Now</button>
          <button type="button" class="seg" data-mode="anniversary" role="radio" aria-checked="false">Anniversary</button>
          <button type="button" class="seg" data-mode="mothers" role="radio" aria-checked="false">Mother's Day</button>
          <button type="button" class="seg" data-mode="christmas" role="radio" aria-checked="false">Christmas</button>
        </div>
      </div>
    </div>
    <div id="grid" class="grid"></div>
    <div class="noscript"><noscript>This page requires JavaScript to build the gallery.</noscript></div>
    <script>
      (function() {
        const grid = document.getElementById('grid');
        const current = new URL(window.location.href);
        const base = new URL('index.html', window.location.href);


        // Optional: support ?ratio=16:9 or ?ratio=4:3 to override tile aspect
        const ratio = current.searchParams.get('ratio');
        if (ratio) {
          const match = ratio.match(/^(\d+)\s*[:/]\s*(\d+)$/);
          if (match) {
            const a = parseInt(match[1], 10), b = parseInt(match[2], 10);
            if (a > 0 && b > 0) {
              document.documentElement.style.setProperty('--tile-aspect', a + ' / ' + b);
            }
          }
        }

        // Preserve current params but remove preset theme; force controls=false
        const preserved = new URLSearchParams(current.search);
        preserved.delete('theme');
        preserved.set('controls', 'false');
        let currentSearch = preserved.toString();


        // Get theme names from ThemeManager; fallback if unavailable
        const names = (window.themeManager && window.themeManager.getThemeNames())
          || ['default','terminal','live-terminal','dos','mac1984'];

        names.forEach(name => {
          const section = document.createElement('div');
          section.className = 'section';
          section.id = name;

          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = name;
          section.appendChild(title);

          const card = document.createElement('div');
          card.className = (name === 'liquid-glass') ? 'card card--lg' : 'card';

          const url = new URL(base);
          url.search = preserved.toString();
          url.searchParams.set('theme', name);

          // Make section title clickable to open theme in a new tab (respect current selected date/mode)
          title.addEventListener('click', () => {
            const link = new URL('index.html', window.location.href);
            link.search = currentSearch;
            link.searchParams.set('theme', name);
            const win = window.open(link.toString(), '_blank');
            if (win) { win.opener = null; }
          });

          const iframe = document.createElement('iframe');
          iframe.loading = 'lazy';
          iframe.referrerPolicy = 'no-referrer';
          iframe.src = url.toString();

          card.appendChild(iframe);
          section.appendChild(card);
          grid.appendChild(section);
        });

        // Date selection logic
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toParamDate(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()); }

        function getFamilyFromParams() {
          const fam = new URL(window.location.href).searchParams.get('family');
          if (fam) {
            try { return JSON.parse(decodeURIComponent(fam)); } catch(e) {}
          }
          // Fallback to defaults used by the default clock
          return {
            parents: {
              mom: { birthday: '1999/05/05' },
              dad: { birthday: '1999/06/10' },
              anniversary: '1999/04/29'
            }
          };
        }

        function getMothersDay(year) {
          const date = new Date(year, 4, 1); // May 1st
          date.setDate(date.getDay() === 0 ? 8 : 15 - date.getDay()); // second Sunday
          return date;
        }

        function dateForMode(mode) {
          const yr = new Date().getFullYear();
          if (mode === 'anniversary') {
            const ann = getFamilyFromParams().parents.anniversary || '2000/01/01';
            const parts = ann.split('/').map(Number);
            return new Date(yr, (parts[1] || 1) - 1, parts[2] || 1);
          }
          if (mode === 'mothers') return getMothersDay(yr);
          if (mode === 'christmas') return new Date(yr, 11, 25);
          return null;
        }

        function applyMode(mode) {
          // update active state
          document.querySelectorAll('.segmented .seg').forEach(btn => {
            const active = btn.dataset.mode === mode;
            btn.classList.toggle('active', active);
            btn.setAttribute('aria-checked', active ? 'true' : 'false');
          });

          // build base params
          const baseParams = new URLSearchParams(window.location.search);
          baseParams.delete('theme');
          baseParams.set('controls', 'false');

          if (mode === 'now') {
            baseParams.delete('date');
          } else {
            const d = dateForMode(mode);
            baseParams.set('date', toParamDate(d));
          }
          currentSearch = baseParams.toString();


          // refresh all iframes
          document.querySelectorAll('.section .card iframe').forEach(iframe => {
            const themeName = iframe.closest('.section')?.id || 'default';
            const url = new URL('index.html', window.location.href);
            url.search = baseParams.toString();
            url.searchParams.set('theme', themeName);
            iframe.src = url.toString();
          });
        }

        // wire up segmented controls
        document.querySelectorAll('.segmented .seg').forEach(btn => {
          btn.addEventListener('click', () => applyMode(btn.dataset.mode));
        });

        // initial state based on existing ?date param if present
        (function initMode() {
          const current = new URL(window.location.href).searchParams.get('date');
          if (!current) return applyMode('now');
          const thisYear = new Date().getFullYear();
          const ann = toParamDate(dateForMode('anniversary'));
          const mom = toParamDate(dateForMode('mothers'));
          const xmas = toParamDate(dateForMode('christmas'));
          if (current === ann) return applyMode('anniversary');
          if (current === mom) return applyMode('mothers');
          if (current === xmas) return applyMode('christmas');
          applyMode('now');
        })();

      })();
    </script>
  </body>
</html>
